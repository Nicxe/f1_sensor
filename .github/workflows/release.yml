name: Release (validate only)

on:
  release:
    types: [released]   # Triggas när du klickar "Publish" för en vanlig release

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout release target (main)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.target_commitish }}

      - name: Ensure release targets main
        run: |
          TARGET="${{ github.event.release.target_commitish }}"
          echo "Target branch: $TARGET"
          if [ "$TARGET" != "main" ]; then
            echo "❌ Stabil release måste rikta mot 'main' men var '$TARGET'."
            exit 1
          fi

      - name: hassfest
        uses: home-assistant/actions/hassfest@master

      - name: HACS validation
        uses: hacs/action@main
        with:
          category: integration

      - name: Verify manifest version matches tag
        run: |
          TAG="${{ github.event.release.tag_name }}"          # ex v2.4.0
          TAG_NO_V="${TAG#v}"                                  # ex 2.4.0
          FILE="custom_components/f1_sensor/manifest.json"

          if [ ! -f "$FILE" ]; then
            echo "❌ Hittar inte manifest.json i $FILE"
            exit 1
          fi

          MANIFEST_VER=$(python - <<'PY'
import json
print(json.load(open("custom_components/f1_sensor/manifest.json"))["version"])
PY
)
          echo "Tag: $TAG_NO_V"
          echo "Manifest: $MANIFEST_VER"

          # Kontrollera att taggen inte är beta
          if echo "$TAG_NO_V" | grep -q -- "-beta."; then
            echo "❌ Stabil release får inte använda beta-tagg."
            exit 1
          fi

          # Kontrollera att version i manifest matchar taggen
          if [ "$MANIFEST_VER" != "$TAG_NO_V" ]; then
            echo "❌ Version i manifest ($MANIFEST_VER) matchar inte taggen ($TAG_NO_V)."
            exit 1
          fi
